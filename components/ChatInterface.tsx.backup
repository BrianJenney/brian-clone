'use client';

import { useRef, useEffect, useState } from 'react';
import { useVoiceInput } from '@/hooks/useVoiceInput';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import { generateContent } from '@/app/actions/generate-content';

type ChatMode = 'standard' | 'contentGen';

type Message = {
	role: 'user' | 'assistant';
	content: string;
};

export default function ChatInterface() {
	const [chatMode, setChatMode] = useState<ChatMode>('standard');
	const [generatedPosts, setGeneratedPosts] = useState<string[]>([]);
	const [isGenerating, setIsGenerating] = useState(false);
	const [generationError, setGenerationError] = useState<string | null>(null);
	const [messages, setMessages] = useState<Message[]>([]);
	const [error, setError] = useState<string | null>(null);
	const [isLoading, setIsLoading] = useState(false);

	const [input, setInput] = useState('');
	const messagesEndRef = useRef<HTMLDivElement>(null);
	const {
		isListening,
		transcript,
		isSupported,
		error: voiceError,
		startListening,
		stopListening,
		resetTranscript,
	} = useVoiceInput();

	const scrollToBottom = () => {
		messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
	};

	const handleInputChange = (e: React.ChangeEvent<HTMLTextAreaElement>) => {
		setInput(e.target.value);
		e.target.style.height = 'auto';
		e.target.style.height = `${Math.min(e.target.scrollHeight, 128)}px`;
	};

	useEffect(() => {
		scrollToBottom();
	}, [messages]);

	// Sync voice transcript with input
	useEffect(() => {
		if (transcript) {
			setInput(transcript);
		}
	}, [transcript]);

	const handleVoiceToggle = () => {
		if (isListening) {
			stopListening();
		} else {
			startListening();
		}
	};

	const handleGenerateContent = async (message: string) => {
		try {
			setIsGenerating(true);
			setGenerationError(null);
			setGeneratedPosts([]);

			const result = await generateContent(message);

			if (result.success && 'options' in result && result.options) {
				setGeneratedPosts(result.options);
			} else {
				throw new Error(
					'message' in result && result.message
						? result.message
						: 'Failed to generate posts'
				);
			}
		} catch (error) {
			console.error('Content generation error:', error);
			setGenerationError(
				error instanceof Error ? error.message : 'Unknown error'
			);
		} finally {
			setIsGenerating(false);
		}
	};

	const handleChatMessage = async (message: string) => {
		try {
			setIsLoading(true);
			setError(null);

			// Add user message
			const userMessage: Message = { role: 'user', content: message };
			setMessages((prev) => [...prev, userMessage]);

			// Call API
			const response = await fetch('/api/chat', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({
					messages: [...messages, userMessage],
				}),
			});

			if (!response.ok) {
				throw new Error('Failed to send message');
			}

			const data = await response.json();

			// Add assistant message
			const assistantMessage: Message = {
				role: 'assistant',
				content: data.content,
			};
			setMessages((prev) => [...prev, assistantMessage]);
		} catch (error) {
			console.error('Chat error:', error);
			setError(error instanceof Error ? error.message : 'Unknown error');
		} finally {
			setIsLoading(false);
		}
	};

	const handleSubmit = (e: React.FormEvent) => {
		e.preventDefault();
		if (!input.trim()) return;

		if (chatMode === 'contentGen') {
			handleGenerateContent(input);
		} else {
			handleChatMessage(input);
		}

		setInput('');
		resetTranscript();
	};

	console.log({ messages });

	return (
		<div className='flex flex-col h-[calc(100vh-300px)] min-h-[400px] max-h-[600px] space-y-4'>
			<div className='flex justify-between items-center'>
				<h2 className='text-xl sm:text-2xl font-bold text-white'>
					AI Writing Assistant
				</h2>
				<div className='flex items-center gap-2 bg-gray-800 p-2 rounded-lg border border-gray-700'>
					<button
						onClick={() => setChatMode('standard')}
						className={`px-3 py-1 text-xs rounded transition-colors ${
							chatMode === 'standard'
								? 'bg-blue-600 text-white font-bold'
								: 'text-gray-400 hover:text-white'
						}`}
						title='Standard chat with AI tools'
					>
						Standard
					</button>

					<button
						onClick={() => setChatMode('contentGen')}
						className={`px-3 py-1 text-xs rounded transition-colors ${
							chatMode === 'contentGen'
								? 'bg-purple-600 text-white font-bold'
								: 'text-gray-400 hover:text-white'
						}`}
						title='Generate 3 posts from templates'
					>
						Content Gen
					</button>
				</div>
			</div>

			{/* Messages Container */}
			<div className='flex-1 overflow-y-auto border border-gray-700 rounded-lg p-4 space-y-4 bg-gray-800'>
				{chatMode === 'contentGen' &&
					generatedPosts.length === 0 &&
					!isGenerating && (
						<div className='text-center text-gray-400 py-8'>
							<p className='text-lg mb-2'>
								Content Generation Mode
							</p>
							<p className='text-sm'>
								Generate 3 unique posts based on Airtable
								templates and your writing style.
							</p>
							<div className='mt-4 text-left max-w-md mx-auto space-y-2'>
								<p className='font-medium'>Example prompts:</p>
								<ul className='list-disc list-inside space-y-1 text-gray-400'>
									<li>
										Create posts about career transitions
									</li>
									<li>Write about learning React in 2025</li>
									<li>
										Generate content on remote work trends
									</li>
									<li>
										Posts about software engineering career
										advice
									</li>
								</ul>
							</div>
						</div>
					)}

				{chatMode !== 'contentGen' && messages.length === 0 && (
					<div className='text-center text-gray-400 py-8'>
						<p className='text-lg mb-2'>
							Welcome! I'm your AI writing assistant.
						</p>
						<p className='text-sm'>
							I can help you write transcripts, articles, and
							posts in your style.
						</p>
						<div className='mt-4 text-left max-w-md mx-auto space-y-2'>
							<p className='font-medium'>Try asking me to:</p>
							<ul className='list-disc list-inside space-y-1 text-gray-400'>
								<li>Search through your existing content</li>
								<li>Generate a new article about a topic</li>
								<li>Write a post in your style</li>
								<li>
									Upload new content to the knowledge base
								</li>
							</ul>
						</div>
					</div>
				)}

				{/* Generated Posts Display */}
				{chatMode === 'contentGen' && generatedPosts.length > 0 && (
					<div className='space-y-4'>
						<div className='bg-purple-900/30 border border-purple-600 rounded-lg p-4'>
							<h3 className='text-purple-400 font-bold mb-2 flex items-center gap-2'>
								<svg
									className='w-5 h-5'
									fill='none'
									stroke='currentColor'
									viewBox='0 0 24 24'
								>
									<path
										strokeLinecap='round'
										strokeLinejoin='round'
										strokeWidth={2}
										d='M5 13l4 4L19 7'
									/>
								</svg>
								Generated 3 Posts Successfully
							</h3>
							<p className='text-gray-300 text-sm'>
								Click on any post to copy it to your clipboard
							</p>
						</div>

						{generatedPosts.map((post, index) => (
							<div
								key={index}
								onClick={() => {
									navigator.clipboard.writeText(post);
									// Optional: show a toast notification
								}}
								className='bg-gray-700 rounded-lg p-4 cursor-pointer hover:bg-gray-600 transition-colors border border-gray-600 hover:border-purple-500'
							>
								<div className='flex justify-between items-start mb-2'>
									<h4 className='text-purple-400 font-bold'>
										Post {index + 1}
									</h4>
									<button
										onClick={(e) => {
											e.stopPropagation();
											navigator.clipboard.writeText(post);
										}}
										className='text-gray-400 hover:text-white transition-colors'
										title='Copy to clipboard'
									>
										<svg
											className='w-5 h-5'
											fill='none'
											stroke='currentColor'
											viewBox='0 0 24 24'
										>
											<path
												strokeLinecap='round'
												strokeLinejoin='round'
												strokeWidth={2}
												d='M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z'
											/>
										</svg>
									</button>
								</div>
								<div className='text-white whitespace-pre-wrap text-sm'>
									{post}
								</div>
							</div>
						))}
					</div>
				)}

				{chatMode !== 'contentGen' &&
					messages.map((message, index) => (
						<div
							key={index}
							className={`flex ${
								message.role === 'user'
									? 'justify-end'
									: 'justify-start'
							}`}
						>
							<div
								className={`max-w-[80%] rounded-lg px-4 py-2 ${
									message.role === 'user'
										? 'bg-blue-600 text-white'
										: 'bg-gray-700 text-white'
								}`}
							>
								{/* Role Label */}
								<div className='text-xs font-medium mb-1 opacity-75'>
									{message.role === 'user'
										? 'You'
										: 'Assistant'}
								</div>

								{/* Message Content */}
								<div className='text-sm'>
									{message.parts.map((part, partIndex) => {
										if (part.type.includes('tool')) {
											return (
												<div
													className='bg-gray-700 text-white p-2 rounded-md'
													key={`${message.id}-tool-result-${partIndex}`}
												>
													{part.type}
												</div>
											);
										}
										if (part.type === 'dynamic-tool') {
											return (
												<div
													key={`${message.id}-tool-${partIndex}`}
												>
													{part.toolName}
												</div>
											);
										}
										if (part.type === 'text') {
											return (
												<div
													key={`${message.id}-text-${partIndex}`}
												>
													{message.role ===
													'assistant' ? (
														<ReactMarkdown
															remarkPlugins={[
																remarkGfm,
															]}
															className='prose prose-invert prose-sm max-w-none'
															components={{
																h1: ({
																	node,
																	...props
																}) => (
																	<h1
																		className='text-xl font-bold mt-4 mb-2'
																		{...props}
																	/>
																),
																h2: ({
																	node,
																	...props
																}) => (
																	<h2
																		className='text-lg font-bold mt-3 mb-2'
																		{...props}
																	/>
																),
																h3: ({
																	node,
																	...props
																}) => (
																	<h3
																		className='text-base font-bold mt-2 mb-1'
																		{...props}
																	/>
																),
																p: ({
																	node,
																	...props
																}) => (
																	<p
																		className='mb-2 last:mb-0'
																		{...props}
																	/>
																),
																ul: ({
																	node,
																	...props
																}) => (
																	<ul
																		className='list-disc list-inside mb-2 space-y-1'
																		{...props}
																	/>
																),
																ol: ({
																	node,
																	...props
																}) => (
																	<ol
																		className='list-decimal list-inside mb-2 space-y-1'
																		{...props}
																	/>
																),
																li: ({
																	node,
																	...props
																}) => (
																	<li
																		className='ml-4'
																		{...props}
																	/>
																),
																code: ({
																	node,
																	...props
																}: any) => {
																	const inline =
																		!props.className;
																	return inline ? (
																		<code
																			className='bg-gray-800 px-1 py-0.5 rounded text-blue-300'
																			{...props}
																		/>
																	) : (
																		<code
																			className='block bg-gray-800 p-2 rounded my-2 overflow-x-auto'
																			{...props}
																		/>
																	);
																},
																blockquote: ({
																	node,
																	...props
																}) => (
																	<blockquote
																		className='border-l-4 border-gray-500 pl-4 my-2 italic'
																		{...props}
																	/>
																),
																a: ({
																	node,
																	...props
																}) => (
																	<a
																		className='text-blue-400 hover:underline'
																		{...props}
																	/>
																),
															}}
														>
															{part.text}
														</ReactMarkdown>
													) : (
														<div className='whitespace-pre-wrap'>
															{part.text}
														</div>
													)}
												</div>
											);
										}
										return null;
									})}
								</div>
							</div>
						</div>
					))}

				<div ref={messagesEndRef} />
			</div>

			{/* Error Messages */}
			{error && (
				<div className='p-3 rounded-md bg-red-900 text-red-200 text-sm'>
					Error: {error}
				</div>
			)}
			{voiceError && (
				<div className='p-3 rounded-md bg-yellow-900 text-yellow-200 text-sm'>
					{voiceError}
				</div>
			)}
			{generationError && (
				<div className='p-3 rounded-md bg-red-900 text-red-200 text-sm'>
					Content Generation Error: {generationError}
				</div>
			)}

			{/* Loading States */}
			{isGenerating && (
				<div className='flex items-center gap-2 p-3 rounded-md bg-purple-900/50 text-purple-200 text-sm'>
					<div className='w-5 h-5 border-2 border-purple-400 border-t-transparent rounded-full animate-spin' />
					<span>Generating 3 posts from templates...</span>
				</div>
			)}
			{isListening && (
				<div className='flex items-center gap-2 p-3 rounded-md bg-blue-900/50 text-blue-200 text-sm animate-pulse'>
					<div className='w-2 h-2 bg-red-500 rounded-full animate-pulse' />
					<span>Listening...</span>
				</div>
			)}

			{/* Input Form */}
			<form onSubmit={handleSubmit} className='flex gap-2'>
				<div className='flex-1 flex gap-2'>
					<textarea
						value={input}
						onChange={handleInputChange}
						onKeyDown={(e) => {
							if (e.key === 'Enter' && !e.shiftKey) {
								e.preventDefault();
								if (input.trim()) {
									handleSubmit(e as any);
									// Reset textarea height
									e.currentTarget.style.height = 'auto';
								}
							}
						}}
						placeholder='Type or use voice... (Shift+Enter for new line)'
						rows={1}
						className='flex-1 px-4 py-2 border border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-gray-700 text-white placeholder-gray-400 resize-none overflow-y-auto max-h-32'
					/>
					{isSupported && (
						<button
							type='button'
							onClick={handleVoiceToggle}
							className={`p-2 rounded-md transition-all ${
								isListening
									? 'bg-red-600 hover:bg-red-700 animate-pulse'
									: 'bg-gray-600 hover:bg-gray-500'
							} text-white`}
							title={
								isListening
									? 'Stop recording'
									: 'Start recording'
							}
						>
							<svg
								xmlns='http://www.w3.org/2000/svg'
								fill='none'
								viewBox='0 0 24 24'
								strokeWidth={1.5}
								stroke='currentColor'
								className='w-6 h-6'
							>
								<path
									strokeLinecap='round'
									strokeLinejoin='round'
									d={
										isListening
											? 'M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z'
											: 'M12 18.75a6 6 0 006-6v-1.5m-6 7.5a6 6 0 01-6-6v-1.5m6 7.5v3.75m-3.75 0h7.5M12 15.75a3 3 0 01-3-3V4.5a3 3 0 116 0v8.25a3 3 0 01-3 3z'
									}
								/>
							</svg>
						</button>
					)}
				</div>
				<button
					type='submit'
					disabled={
						!input.trim() || isLoading || isGenerating
					}
					className={`px-4 sm:px-6 py-2 ${
						chatMode === 'contentGen'
							? 'bg-purple-600 hover:bg-purple-700 disabled:bg-purple-400'
							: 'bg-blue-600 hover:bg-blue-700 disabled:bg-blue-400'
					} disabled:cursor-not-allowed text-white font-medium rounded-md transition-colors`}
				>
					{chatMode === 'contentGen' ? 'Generate' : 'Send'}
				</button>
			</form>
		</div>
	);
}
